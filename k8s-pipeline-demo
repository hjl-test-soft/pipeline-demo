
#https://blog.csdn.net/weixin_36255893/article/details/112495305

pipeline {    
	agent none    
	stages {        
		stage('拉取代码') {            
			agent {                
				label 'master'            
			}            
			steps {                
				echo "1.Git Clone Code"                
				git url: "https://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@github.com/hjl-test-soft/pipeline-demo.git"            
			}        
		}        
		stage('Maven Build') {            
			agent {
	        	docker {
					image 'maven:latest'
				 	args '-v /root/.m2:/root/.m2'
				 }            
			}            
			steps {
			        echo "2.Maven Build Stage"
	                sh 'mvn -B clean package -Dmaven.test.skip=true'
	               }        
	    }
	    stage('Image Build') {
            agent { 
                    label 'master'
                   } 
            steps {            
            		echo "3.Image Build Stage"            
            		sh 'docker build -f Dockerfile --build-arg jar_name=target/prometheus-test-demo-0.0.1-SNAPSHOT.jar -t prometheus-test-demo:${BUILD_ID} . '            
            		sh 'docker tag  prometheus-test-demo:${BUILD_ID}  harbor.edu.cn/library/prometheus-test-demo:${BUILD_ID}'            
            }        
        }
        stage('Push') {            
        	agent {                
        			label 'master'            
        		}            
        	steps {            
        		echo "4.Push Docker Image Stage"            
        		sh "docker login --username=admin harbor.edu.cn -p Harbor12345"            
        		sh "docker push harbor.edu.cn/library/prometheus-test-demo:${BUILD_ID}"            
        	}        
        }    
    }
} 
node('slave') {
    container('jnlp-kubectl') {                
	    stage('Clone YAML') {        
	    		echo "5. Git Clone YAML To Slave"        
	    		git url: "https://github.com/0820sdd/prometheus-test-demo.git"       
	    } 
	    stage('YAML') {        
	    		echo "6. Change YAML File Stage"        
	    		sh 'sed -i "s#{VERSION}#${BUILD_ID}#g" ./jenkins/scripts/prometheus-test-demo.yaml'        
	    }            
	   	stage('Deploy') {        
	   			echo "7. Deploy To K8s Stage"        
	   			sh 'kubectl apply -f ./jenkins/scripts/prometheus-test-demo.yaml'        
	   	}    
   	}
}

